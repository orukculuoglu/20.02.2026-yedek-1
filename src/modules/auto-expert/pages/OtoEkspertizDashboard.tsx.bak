/**
 * Oto Ekspertiz Dashboard - KPI Dashboard for Auto Inspector Module
 * Stage 4: Analytics and reporting for finalized reports
 */

import React, { useMemo, useEffect } from 'react';
import type { ExpertReport } from '../types';
import { reportStore } from '../store';
import { vehicleStore } from '../vehicle/vehicleStore';
import { StatusBadge } from '../components/StatusBadge';

interface OtoEkspertizDashboardProps {
  onViewReports: () => void;
  onViewDetail: (reportId: string) => void;
}

interface KpiCardProps {
  label: string;
  value: string | number;
  subtitle?: string;
  color?: 'blue' | 'green' | 'yellow' | 'red';
}

function KpiCard({ label, value, subtitle, color = 'blue' }: KpiCardProps) {
  const colorClasses = {
    blue: 'bg-blue-50 border-blue-200',
    green: 'bg-green-50 border-green-200',
    yellow: 'bg-yellow-50 border-yellow-200',
    red: 'bg-red-50 border-red-200',
  };

  const textColors = {
    blue: 'text-blue-700',
    green: 'text-green-700',
    yellow: 'text-yellow-700',
    red: 'text-red-700',
  };

  return (
    <div className={`border rounded-lg p-6 ${colorClasses[color]}`}>
      <div className="text-sm font-semibold text-gray-600 mb-2">{label}</div>
      <div className={`text-4xl font-bold ${textColors[color]} mb-1`}>
        {value}
      </div>
      {subtitle && (
        <div className="text-xs text-gray-500">{subtitle}</div>
      )}
    </div>
  );
}

interface ScoreBucketProps {
  label: string;
  count: number;
  maxCount: number;
}

function ScoreBucket({ label, count, maxCount }: ScoreBucketProps) {
  const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;

  return (
    <div className="mb-4">
      <div className="flex items-center justify-between mb-2">
        <span className="text-sm font-medium text-gray-700">{label}</span>
        <span className="text-sm font-bold text-gray-900">{count}</span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
        <div
          className="bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full transition-all"
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}

interface RecentReportRowProps {
  report: ExpertReport;
  onNavigate: (reportId: string) => void;
}

function RecentReportRow({ report, onNavigate }: RecentReportRowProps) {
  const getRiskBadgeColor = () => {
    if (report.riskFlags.length === 0) return 'text-green-600';
    if (report.riskFlags.length === 1) return 'text-yellow-600';
    return 'text-red-600';
  };

  return (
    <div
      onClick={() => onNavigate(report.id)}
      className="flex items-center justify-between p-4 border-b last:border-b-0 hover:bg-gray-50 cursor-pointer transition"
    >
      <div className="flex-1">
        <div className="font-semibold text-gray-900">{report.plate}</div>
        <div className="text-xs text-gray-500">
          {report.vin.slice(0, 4)}...{report.vin.slice(-4)}
        </div>
      </div>

      <div className="flex items-center gap-4">
        <div className="text-center">
          <div className="text-sm font-bold text-gray-900">{report.score}</div>
          <div className="text-xs text-gray-500">Puan</div>
        </div>

        <div className={`text-sm font-semibold ${getRiskBadgeColor()}`}>
          {report.riskFlags.length === 0 && '‚úì D√º≈ü√ºk'}
          {report.riskFlags.length === 1 && '‚ö† Orta'}
          {report.riskFlags.length > 1 && '‚ö†‚ö† Y√ºksek'}
        </div>

        <div className="text-xs text-gray-500 text-right">
          {new Date(report.finalizedAt || report.createdAt).toLocaleDateString(
            'tr-TR'
          )}
        </div>
      </div>
    </div>
  );
}

interface VehicleRiskRowProps {
  plate: string;
  vin: string;
  riskScore: number;
}

function VehicleRiskRow({ plate, vin, riskScore }: VehicleRiskRowProps) {
  const getRiskColor = () => {
    if (riskScore <= 40) return 'text-green-600';
    if (riskScore <= 70) return 'text-yellow-600';
    return 'text-red-600';
  };

  return (
    <div className="flex items-center justify-between p-4 border-b last:border-b-0">
      <div className="flex-1">
        <div className="font-semibold text-gray-900">{plate}</div>
        <div className="text-xs text-gray-500">
          {vin.slice(0, 4)}...{vin.slice(-4)}
        </div>
      </div>

      <div className={`text-lg font-bold ${getRiskColor()}`}>
        {riskScore}/100
      </div>
    </div>
  );
}

export function OtoEkspertizDashboard({ onViewReports, onViewDetail }: OtoEkspertizDashboardProps) {
  // Debug: Log mount
  useEffect(() => {
    console.log('[Dashboard] ‚úì OtoEkspertizDashboard mounted');
    return () => {
      console.log('[Dashboard] ‚úó OtoEkspertizDashboard unmounted');
    };
  }, []);

  // Load data with error handling
  const allReports = useMemo(() => {
    try {
      const reports = reportStore.loadAll();
      console.log('[Dashboard] Loaded reports:', reports.length);
      return reports;
    } catch (err) {
      console.error('[Dashboard] Failed to load reports:', err);
      return [];
    }
  }, []);

  const allVehicles = useMemo(() => {
    try {
      const vehicles = vehicleStore.loadAll();
      console.log('[Dashboard] Loaded vehicles:', vehicles.length);
      return vehicles;
    } catch (err) {
      console.error('[Dashboard] Failed to load vehicles:', err);
      return [];
    }
  }, []);

  // Filter final reports only
  const finalReports = useMemo(
    () => allReports.filter(r => r.status === 'Final'),
    [allReports]
  );

  // KPI 1: Final Report Count
  const finalCount = finalReports.length;

  // KPI 2: Average Expert Score
  const avgScore = useMemo(() => {
    if (finalReports.length === 0) return 0;
    const sum = finalReports.reduce((acc, r) => acc + r.score, 0);
    return Math.round(sum / finalReports.length);
  }, [finalReports]);

  // KPI 3: Risky Vehicle Rate (%)
  const riskyRate = useMemo(() => {
    if (finalReports.length === 0) return 0;
    const riskyCount = finalReports.filter(
      r => r.riskFlags && r.riskFlags.length > 0
    ).length;
    return Math.round((riskyCount / finalReports.length) * 100);
  }, [finalReports]);

  // KPI 4: Total Major Findings
  const majorCount = useMemo(() => {
    return finalReports.reduce((acc, report) => {
      const majorItems = report.checklist
        .flatMap(section => section.items)
        .filter(item => item.result === 'Major').length;
      return acc + majorItems;
    }, 0);
  }, [finalReports]);

  // Score Distribution
  const scoreDistribution = useMemo(() => {
    const b0_60 = finalReports.filter(r => r.score <= 60).length;
    const b61_80 = finalReports.filter(r => r.score >= 61 && r.score <= 80)
      .length;
    const b81_100 = finalReports.filter(r => r.score >= 81).length;
    const maxBucket = Math.max(b0_60, b61_80, b81_100, 1);

    return { b0_60, b61_80, b81_100, maxBucket };
  }, [finalReports]);

  // Recent Final Reports (sorted by finalizedAt DESC, take 5)
  const recentReports = useMemo(() => {
    return [...finalReports]
      .sort(
        (a, b) =>
          new Date(b.finalizedAt || b.createdAt).getTime() -
          new Date(a.finalizedAt || a.createdAt).getTime()
      )
      .slice(0, 5);
  }, [finalReports]);

  // Top Risk Vehicles (sorted by riskScore DESC, take 5)
  const topRiskVehicles = useMemo(() => {
    return allVehicles
      .filter(v => v.riskScore !== undefined)
      .sort((a, b) => (b.riskScore || 0) - (a.riskScore || 0))
      .slice(0, 5);
  }, [allVehicles]);

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* PROMINENT DEBUG BANNER - ALWAYS VISIBLE */}
        <div className="mb-6 p-4 bg-red-100 border-4 border-red-500 rounded-lg shadow-lg">
          <div className="text-red-900 font-bold text-lg">üî¥ OTO EKSPERTIZ DASHBOARD MOUNTED</div>
          <div className="text-red-800 text-sm mt-2">Pathname: {typeof window !== 'undefined' ? window.location.pathname : 'unknown'}</div>
          <div className="text-red-800 text-sm">Props received: onViewReports={typeof onViewReports}, onViewDetail={typeof onViewDetail}</div>
        </div>

        {/* Header - ALWAYS VISIBLE */}
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Oto Ekspertiz Panosu
          </h1>
          <p className="text-gray-600">
            Kesinle≈ütirilen t√ºm raporlardan olu≈üan analitik ve istatistikler
          </p>
          {/* Debug Info - Shows data loading status */}
          <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700 font-mono">
            [Debug] Raporlar: {allReports.length} | Kesinle≈ütirilmi≈ü: {finalReports.length} | Ara√ßlar: {allVehicles.length}
          </div>
        </div>

        {/* KPI Grid - Always visible */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <KpiCard
            label="Kesinle≈ütirilmi≈ü Raporlar"
            value={finalCount}
            subtitle={finalCount === 0 ? "Hen√ºz rapor yok" : "Toplam finalize rapor"}
            color="blue"
          />
          <KpiCard
            label="Ortalama Uzman Puanƒ±"
            value={avgScore}
            subtitle="0-100 √∂l√ßeƒüinde"
            color="green"
          />
          <KpiCard
            label="Riskli Ara√ß Oranƒ±"
            value={`${riskyRate}%`}
            subtitle={`${finalReports.length} ara√ßta`}
            color={riskyRate > 50 ? 'red' : 'yellow'}
          />
          <KpiCard
            label="Toplam Ciddi Bulgular"
            value={majorCount}
            subtitle="Major kategorisinde"
            color="red"
          />
        </div>

        {/* Content Grid: Score Distribution + Recent Reports */}
        {finalCount > 0 ? (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            {/* Score Distribution */}
            <div className="bg-white border border-gray-200 rounded-lg p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-6">
                Puan Daƒüƒ±lƒ±mƒ±
              </h2>

              <ScoreBucket
                label="0-60 (D√º≈ü√ºk)"
                count={scoreDistribution.b0_60}
                maxCount={scoreDistribution.maxBucket}
              />
              <ScoreBucket
                label="61-80 (Orta)"
                count={scoreDistribution.b61_80}
                maxCount={scoreDistribution.maxBucket}
              />
              <ScoreBucket
                label="81-100 (Y√ºksek)"
                count={scoreDistribution.b81_100}
                maxCount={scoreDistribution.maxBucket}
              />

              <div className="mt-6 pt-6 border-t border-gray-200">
                <button
                  onClick={onViewReports}
                  className="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"
                >
                  T√ºm Raporlarƒ± G√∂r
                </button>
              </div>
            </div>

            {/* Recent Final Reports */}
            <div className="lg:col-span-2 bg-white border border-gray-200 rounded-lg overflow-hidden">
              <div className="p-6 border-b border-gray-200">
                <h2 className="text-lg font-semibold text-gray-900">
                  Son Kesinle≈ütirilmi≈ü Raporlar
                </h2>
              </div>

              <div>
                {recentReports.length > 0 ? (
                  recentReports.map(report => (
                    <RecentReportRow
                      key={report.id}
                      report={report}
                      onNavigate={onViewDetail}
                    />
                  ))
                ) : (
                  <div className="p-6 text-center text-gray-500">
                    Hen√ºz kesinle≈ütirilen rapor yok
                  </div>
                )}
              </div>
            </div>
          </div>
        ) : (
          <div className="bg-white border border-gray-200 rounded-lg p-12 text-center mb-8">
            <div className="text-6xl mb-4">üìä</div>
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">
              Veri Yok
            </h2>
            <p className="text-gray-600 mb-6">
              Hen√ºz kesinle≈ütirilen rapor bulunmamaktadƒ±r. Raporlarƒ±
              g√∂r√ºnt√ºlemek i√ßin l√ºtfen tƒ±klayƒ±n.
            </p>
            <button
              onClick={onViewReports}
              className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"
            >
              Raporlar B√∂l√ºm√ºne Git
            </button>
          </div>
        )}

        {/* Top Risk Vehicles */}
        {topRiskVehicles.length > 0 && (
          <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div className="p-6 border-b border-gray-200">
              <h2 className="text-lg font-semibold text-gray-900">
                En Y√ºksek Risk Puanƒ± Olan Ara√ßlar
              </h2>
              <p className="text-sm text-gray-600 mt-1">
                Risk Engine tarafƒ±ndan hesaplanan puanlar
              </p>
            </div>

            <div>
              {topRiskVehicles.map(vehicle => (
                <VehicleRiskRow
                  key={vehicle.id}
                  plate={vehicle.plate}
                  vin={vehicle.vin}
                  riskScore={vehicle.riskScore || 0}
                />
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
