# V2.2.1 Service Redirect Status Change Verification Test

## Overview
Verify that the service redirect feature correctly changes vehicle status based on the fleet policy and redirect settings.

---

## Test Vehicle Setup
- **Fleet:** Marmara Filo (FLEET-001)
- **Vehicle:** VEH-002 (Hyundai H350)
- **Initial Status:** ACTIVE âœ…
- **Initial Redirects:** 0 (clean) âœ…
- **Service Points:** Available (SP-001, SP-003, etc.) âœ…

---

## Test Flow 1: Policy OFF â†’ Status Should Stay ACTIVE

### Prerequisites
- Policy: FLEET-001 autoSetServicedOnRedirect = **FALSE**
- Vehicle Status: **ACTIVE**

### Steps
1. **Navigate to Fleet Rental**
   - Select Fleet: "Marmara Filo A.Åž." (FLEET-001)
   - Should auto-load

2. **Select Vehicle from list**
   - Click on: "Hyundai | 34ABC0002 | VEH-002"
   - Fleet should show vehicle details

3. **Click "AraÃ§ Ã–zeti" Tab**
   - Should load vehicle summary
   - Look for "Durum:" badge showing green "ACTIVE"

4. **Check Policy Toggle**
   - See: "YÃ¶nlendirme sonrasÄ± otomatik Serviced yap"
   - Toggle should be: **OFF** (gray)
   - Click toggle to verify it's OFF

5. **Create Service Redirect**
   - Scroll down to "Servis NoktalarÄ±"
   - Click "YÃ¶nlendir (V2.2)" on any service point (SP-001 recommended)
   - Modal appears:
     - Reason: Select "Periyodik BakÄ±m"
     - Not: Leave empty
     - Checkbox: "YÃ¶nlendirme sonrasÄ± aracÄ± Serviced yap" should be **UNCHECKED**
   - Click "Kaydet"

6. **Verify Status UNCHANGED**
   - Toast appears: "YÃ¶nlendirme kaydedildi" âœ…
   - Reload redirects: Modal closes
   - Vehicle summary reloads
   - **CRITICAL:** "Durum:" badge still shows **GREEN "ACTIVE"** 
   - **NETWORK:** Should see:
     - POST /api/vehicle/VEH-002/service-redirects
     - GET /api/vehicle/VEH-002/summary (refetch)
   - Status did NOT change âœ…

### Expected Result: âœ… PASS
- Status badge stays green/ACTIVE
- Network shows POST then GET summary
- Redirect record created with applyStatusChange=false

---

## Test Flow 2: Policy ON â†’ Status Should Change to SERVICED

### Prerequisites
- After Test Flow 1
- Vehicle Status: Still **ACTIVE** (from previous flow)

### Steps
1. **Open Policy Toggle**
   - See: "YÃ¶nlendirme sonrasÄ± otomatik Serviced yap"
   - Click toggle to turn it **ON** (blue/green)
   - Should update policy

2. **Verify Toggle Changed**
   - Toggle now shows **ON**
   - Checkbox in form should now default to checked

3. **Create Another Service Redirect**
   - Scroll to "Servis NoktalarÄ±"
   - Click "YÃ¶nlendir (V2.2)" on another point (SP-003)
   - Modal appears:
     - Reason: Select "ArÄ±za"
     - Note: Type "Test redirect with status change"
     - Checkbox: "YÃ¶nlendirme sonrasÄ± aracÄ± Serviced yap" should be **CHECKED** (default from policy)
   - Click "Kaydet"

4. **Verify Status CHANGED**
   - Toast appears: "YÃ¶nlendirme kaydedildi" âœ…
   - Vehicle summary reloads
   - **CRITICAL:** "Durum:" badge now shows **BLUE "Serviced"** 
   - **NETWORK:** Should see:
     - POST /api/vehicle/VEH-002/service-redirects
     - GET /api/vehicle/VEH-002/summary (refetch)
   - Status changed to Serviced âœ…

### Expected Result: âœ… PASS
- Status badge changes from green/ACTIVE to blue/SERVICED
- Network shows POST then GET summary
- Redirect record created with applyStatusChange=true
- "Son Servis YÃ¶nlendirmeleri" list shows 2 redirects

---

## Expected Network Requests (DevTools F12)

### Test Flow 1 - Policy OFF
```
POST http://localhost:3001/api/vehicle/VEH-002/service-redirects
Response: {
  redirect: { redirectId, vehicleId, ..., applyStatusChange: false },
  updatedVehicle: { vehicleId, status: "ACTIVE", applyStatusChange: false }
}

GET http://localhost:3001/api/vehicle/VEH-002/summary
Response: { status: "ACTIVE", ... }
```

### Test Flow 2 - Policy ON
```
POST http://localhost:3001/api/vehicle/VEH-002/service-redirects
Response: {
  redirect: { redirectId, vehicleId, ..., applyStatusChange: true, newStatus: "Serviced" },
  updatedVehicle: { vehicleId, status: "Serviced", applyStatusChange: true }
}

GET http://localhost:3001/api/vehicle/VEH-002/summary
Response: { status: "Serviced", ... }
```

---

## Verification Checklist

### Seed Data âœ…
- [ ] VEH-002 has status="ACTIVE"
- [ ] VEH-002 starts with 0 redirects
- [ ] FLEET-001 policy exists with autoSetServicedOnRedirect=true

### Server Endpoint âœ…
- [ ] POST /api/vehicle/:vehicleId/service-redirects accepts servicePointId, reason, note, applyStatusChange
- [ ] When applyStatusChange=true: vehicle.status â†’ "Serviced"
- [ ] When applyStatusChange=false: vehicle.status unchanged
- [ ] Response includes updatedVehicle with status field

### UI Updates âœ…
- [ ] Status badge added: SERVICED shows as blue
- [ ] Gettext badge shows ACTIVE as green when status="ACTIVE"
- [ ] After redirect: summary refetches (network visible)
- [ ] Badge updates immediately/within 2 seconds

### Role Enforcement âœ…
- [ ] Viewer role: "YÃ¶nlendir" button disabled (grayed out)
- [ ] Viewer role: Policy toggle disabled
- [ ] Viewer role: 403 on POST attempt

---

## Exit Criteria (ALL MUST PASS)

1. âœ… Same vehicle (VEH-002) with Policy OFF
   - Redirect created â†’ Status stays ACTIVE
   - Network shows POST + GET summary

2. âœ… Same vehicle (VEH-002) with Policy ON
   - Redirect created â†’ Status becomes SERVICED
   - Network shows POST + GET summary

3. âœ… UI Badge Updates Immediately
   - Badge color changes from green to blue
   - Badge text changes from "ACTIVE" to "Serviced"
   - Happens within 2 seconds of redirect creation

4. âœ… Network Visibility
   - DevTools shows POST service-redirects call
   - DevTools shows GET summary call immediately after
   - Response payload confirms status change

---

## Rollback/Troubleshooting

If any test fails:

1. **Status not changing:**
   - Check POST response: does updatedVehicle.status show correct value?
   - Check GET summary response: is status field updated?
   - Verify vehicle object mutation in mock server

2. **Badge not updating:**
   - Verify getStatusClass includes "SERVICED" case
   - Check if vehicleSummary state updates (React DevTools)
   - Verify UI re-renders after summary state change

3. **Network calls missing:**
   - Open DevTools F12 â†’ Network tab
   - Manually trigger redirect
   - Verify POST appears â†’ GET summary appears in sequence

4. **Policy toggle not working:**
   - Check PATCH /api/fleet/:fleetId/policy response
   - Verify MOCK_FLEET_POLICIES updates
   - Check if form default checkbox updates after toggle

---

## Success Indicator ðŸŽ¯

**All requirements met when:**
1. Policy OFF + redirect â†’ Vehicle stays ACTIVE (green badge)
2. Policy ON + redirect â†’ Vehicle becomes SERVICED (blue badge)  
3. Badge updates appear automatically in UI
4. Network tab shows full POST â†’ GET flow
5. "Son Servis YÃ¶nlendirmeleri" list grows with each redirect
