Get-Process -Name node -ErrorAction SilentlyContinue | Stop-Process -Force
npm run dev:mock-server    # Terminal 1'de
npm run dev                 # Terminal 2'de# V2.6 Persistence - Quick Test Guide

## âœ… Test End-to-End with Persistence

### Setup (1 min)
```bash
# Terminal 1: Start mock server (creates .mock-persistence/)
npm run dev:mock-server

# Terminal 2: Start frontend (wait 2s)
Start-Sleep -Seconds 2
npm run dev
```

---

## Test Scenario 1: Create â†’ Refresh â†’ Verify (5 min)

### Step 1: Create Appointment
1. Open browser: http://localhost:3003
2. Go to **Filo Kiralama** (Fleet Rental)
3. Click **+ Yeni AraÃ§** (New Vehicle)
4. Fill form:
   - AraÃ§: VEH-001 (or any vehicle)
   - Servis Ä°Ã§in Sebep: Select a service point
   - Select redirectType: RoutineMaintenance or BreakdownIncident
5. Click **GÃ¶nder** (Submit)

### Expected Response 1
```json
{
  "redirectId": "RD-...",
  "appointmentId": "APT-...",  â† NEW APPOINTMENT CREATED
  "redirect": { ... },
  "appointment": { ... },
  "updatedVehicle": { ... }
}
```

âœ… Check Network â†’ Verify response includes appointmentId

### Step 2: List Appointments
1. Navigate to **BakÄ±m Merkezi** â†’ **Randevular**
2. Should see the new appointment in the list
3. Status should be: **PlanlanmÄ±ÅŸ** (Scheduled)

### Step 3: Accept Appointment
1. Find the new appointment row
2. Click **âœ“ AraÃ§ Kabul** button
3. Modal should appear showing WorkOrder details
4. Should see origin info:
   - ğŸš— Kaynak: Filo Kiralama
   - ğŸ“… GeliÅŸ Modu: Randevu

### Step 4: View in Kanban
1. Auto-navigated to **Ä°ÅŸ Emirleri** (RepairShops)
2. Click **Ä°ÅŸ Emirleri (Kanban)** tab
3. **NEW WORK ORDER CARD** should appear in first column "AraÃ§ Kabul"

### Step 5: Refresh Page (F5)
```
Press F5 in browser
OR
Navigate away and back: F9 DevTools â†’ Console â†’ location.reload()
```

### Step 6: Verify Persistence âœ…
After refresh:
1. **Randevular** page should still show the appointment
2. Status should still be: **Kabul edildi** (Accepted)
3. Navigate to **Ä°ÅŸ Emirleri** (Kanban)
4. **WORK ORDER CARD STILL VISIBLE** in "AraÃ§ Kabul" column

### Step 7: Check Persisted Files
Open terminal:
```bash
# List persistence directory
ls -la .mock-persistence/

# View appointments
cat .mock-persistence/appointments.json

# View work orders
cat .mock-persistence/workorders.json
```

**Expected Output**:
```
.mock-persistence/
â”œâ”€â”€ appointments.json (contains your new appointment with "Accepted" status)
â””â”€â”€ workorders.json (contains your new work order with "Open" status)
```

---

## Test Scenario 2: Multiple Appointments â†’ Restart Server (10 min)

### Step 1: Create Multiple Appointments (3x)
1. Go to Filo Kiralama
2. Create 3 different appointments (different vehicles/service points)
3. Accept all 3 â†’ All should appear in Kanban "AraÃ§ Kabul" column

### Step 2: Verify All 3 in Kanban
- Count cards in "AraÃ§ Kabul" column: Should be 3

### Step 3: Stop Server
```bash
# Terminal 1: Stop mock server
Ctrl+C
```

### Step 4: Check Persisted Files
```bash
# View the persisted workorders
cat .mock-persistence/workorders.json

# Should show 3 work orders:
# [
#   { workOrderId: "WO-...", tenantId: "FLEET-001", status: "Open", ... },
#   { workOrderId: "WO-...", tenantId: "FLEET-001", status: "Open", ... },
#   { workOrderId: "WO-...", tenantId: "FLEET-001", status: "Open", ... }
# ]
```

### Step 5: Restart Server
```bash
# Terminal 1: Restart mock server
npm run dev:mock-server
```

### Step 6: Verify Data Loaded from Disk âœ…
1. Refresh browser (F5)
2. Go to **Ä°ÅŸ Emirleri** (Kanban)
3. **ALL 3 WORK ORDER CARDS SHOULD BE VISIBLE**
4. No data lost!

---

## Test Scenario 3: Approval Workflow Persistence (10 min)

### Step 1: Create and Accept Appointment
(Same as Test 1, Steps 1-4)

### Step 2: Request Approval
1. In Kanban, find the Work Order card
2. Click card â†’ Right panel opens
3. Find "REQUEST APPROVAL" button
4. Click â†’ Modal or response shows approval requested

### Step 3: Refresh Page (F5)
1. Refresh browser
2. Click same Work Order card
3. **Approval status should still show "Requested"** âœ…

### Step 4: Approve Workflow
1. Find "APPROVE" button
2. Fill approval form (if exists)
3. Click "APPROVE"

### Step 5: Refresh Again (F5)
1. Refresh browser
2. Click same Work Order card
3. **Approval status should still show "Approved"** âœ…

### Step 6: Server Restart
1. Stop server (Ctrl+C)
2. Check persisted file:
   ```bash
   cat .mock-persistence/workorders.json | grep -A 10 '"approval"'
   # Should show: "status": "Approved"
   ```
3. Restart server
4. Refresh browser
5. **Approval still shows "Approved"** after server restart âœ…

---

## Debugging Checklist

### If WorkOrder Disappears After Refresh

**Check 1: Files Created**
```bash
ls -la .mock-persistence/
# Should show: appointments.json and workorders.json
```

**Check 2: File Contents**
```bash
cat .mock-persistence/workorders.json
# Should NOT be empty: should have [ { workOrderId: ..., } ]
```

**Check 3: Server Log**
```bash
# Look for errors in server console
# Should see: "All node processes stopped" + server restart
# NO errors about "Error saving workorders"
```

**Check 4: Network Requests**
```bash
# Browser DevTools â†’ Network tab
# After refresh:
GET /api/workorders?fleetId=FLEET-001
# Should return array with workorders (status 200)
```

**Check 5: Clear and Retry**
```bash
# Delete persistence directory
rm -rf .mock-persistence/

# Stop and restart server
# Ctrl+C in Terminal 1
npm run dev:mock-server

# Try test again from scratch
```

---

## Expected Behavior Summary

| Action | Before (No Persistence) | After (With Persistence) |
|--------|------------------------|-----------------------|
| Create appointment | âœ… Works | âœ… Works |
| Accept appointment | âœ… Works | âœ… Works |
| View in Kanban | âœ… Works | âœ… Works |
| **Refresh page** | âŒ WorkOrder gone | âœ… WorkOrder persists |
| **Server restart** | âŒ All data lost | âœ… All data restored |
| Add line items | âœ… Works | âœ… Works + persists |
| Request approval | âœ… Works | âœ… Works + persists |
| Approve work order | âœ… Works | âœ… Works + persists |
| **Refresh after approve** | âŒ Status reverts | âœ… Status persists |

---

## Success Criteria âœ…

- [ ] WorkOrder persists after F5 refresh
- [ ] Appointment shows "Kabul edildi" status after refresh
- [ ] Kanban card visible after refresh
- [ ] Multiple appointments all saved
- [ ] Server restart loads all data
- [ ] File ownership correct (can read/write)
- [ ] No errors in console
- [ ] Approval status persists

---

## Performance Expectations

- File save: ~1ms (very fast)
- File load on startup: ~1ms
- No UI lag or blocking
- Works with 10-100+ work orders
- Ready for production mock testing

---

## Next Steps After Testing

1. âœ… Verify all test scenarios pass
2. âœ… Report any issues with file persistence
3. âœ… Then move to next V2.6 improvements

---

**Ready to Test!**

Run these commands to start:
```bash
npm run dev:mock-server     # Terminal 1  
Start-Sleep -Seconds 2; npm run dev   # Terminal 2
```

Then follow **Test Scenario 1** above.

Report any issues with file paths or persistence errors!
