# V2.3 Work Order Integration - Implementation Summary

## Overview
V2.3 integrates Work Order management with Service Redirects for complete job tracking workflow.

**Goal:** Link service redirects (where vehicles go) to work orders (what work is assigned) for operational closure.

## What Changed

### 1. Data Models (✅ Complete)

**types/fleetRental.ts**
```typescript
export interface WorkOrder {
  workOrderId: string;           // WO-XXX
  vehicleId: string;              // Vehicle being serviced
  fleetId: string;                // Which fleet
  servicePointId: string;         // Where it's being serviced
  source: 'FleetRedirect';        // Always "FleetRedirect" (v2.3)
  status: 'Open' | 'InProgress' | 'Closed';
  createdAt: string;              // ISO timestamp
}

// Extended ServiceRedirect with optional work order link
export interface ServiceRedirect {
  // ... existing fields
  workOrderId?: string;           // NEW: V2.3 - Link to work order
}
```

### 2. Seed Data (✅ Complete)

**src/mocks/fleetRentalSeed.ts + fleetRentalSeed.mjs**
```typescript
export const MOCK_WORK_ORDERS: WorkOrder[] = [];  // Starts empty, created on demand
```

### 3. Server Endpoints (✅ Complete)

**start-mock-server.mjs - Two New Endpoints:**

#### A. POST /api/service-redirects/:redirectId/create-workorder
Creates a work order from an existing service redirect.

**Request:**
- Method: POST
- URL: `/api/service-redirects/{redirectId}/create-workorder`
- Headers: x-tenant-id (required), x-role (required)
- Body: Empty (no JSON body required)

**Response (Success - 200):**
```json
{
  "workOrderId": "WO-abc123xyz",
  "status": "Open"
}
```

**Error Handling:**
- **403 Forbidden:** If role === 'viewer' (blocked from write operations)
- **404 Not Found:** If redirect doesn't exist
- **409 Conflict:** If redirect already has a workOrderId

**Logic:**
1. Check role is not 'viewer' → 403
2. Find redirect by redirectId
3. Check redirect exists → 404 if not
4. Check redirect.workOrderId not set → 409 if already exists
5. Generate workOrderId: `"WO-" + random(9 chars)`
6. Create WorkOrder object with source="FleetRedirect", status="Open"
7. Link back: redirect.workOrderId = workOrderId
8. Push to MOCK_WORK_ORDERS array
9. Return {workOrderId, status}

#### B. GET /api/workorders?fleetId=FLEET-001
List all work orders (optionally filtered by fleet).

**Request:**
- Method: GET
- URL: `/api/workorders` or `/api/workorders?fleetId=FLEET-001`
- Headers: x-tenant-id (required), x-role (required)

**Response (200):**
```json
[
  {
    "workOrderId": "WO-abc123xyz",
    "vehicleId": "VEH-001",
    "fleetId": "FLEET-001",
    "servicePointId": "SP-MAIN",
    "source": "FleetRedirect",
    "status": "Open",
    "createdAt": "2025-01-XX..."
  }
]
```

**Logic:**
1. Extract fleetId from query params (optional)
2. Filter MOCK_WORK_ORDERS by fleetId if provided
3. Return filtered array

### 4. Data Client Functions (✅ Complete)

**services/fleetRentalService.ts - Two New Functions:**

#### A. createWorkOrder(redirectId: string)
```typescript
export async function createWorkOrder(
  redirectId: string
): Promise<{ workOrderId: string; status: string }>
```

**Behavior:**
- POST to `/api/service-redirects/{redirectId}/create-workorder`
- Returns {workOrderId, status}
- Throws specific errors for 403/404/409

#### B. listWorkOrders(fleetId?: string)
```typescript
export async function listWorkOrders(
  fleetId?: string
): Promise<WorkOrder[]>
```

**Behavior:**
- GET `/api/workorders?fleetId={fleetId}` if fleetId provided
- Returns WorkOrder[] array
- Includes tenant headers on all requests

### 5. UI Updates (✅ Complete)

**views/FleetRental.tsx**

**New State:**
```typescript
const [workOrderCreating, setWorkOrderCreating] = useState<{
  [redirectId: string]: boolean;
}>({});
```

**New Handler:**
```typescript
const handleCreateWorkOrder = async (redirectId: string) => {
  // 1. Set loading for this redirect
  // 2. Call createWorkOrder(redirectId)
  // 3. Show success toast "İş Emri oluşturuldu"
  // 4. Reload serviceRedirects list
  // 5. Handle errors with setError
}
```

**UI Changes - "Son Servis Yönlendirmeleri" Section:**

Each redirect row now shows conditional buttons:

**If NO workOrderId:**
- Button: "İş Emri Aç" (green, enabled for non-viewer roles)
  - Disabled if viewer role (→ 403)
  - Shows "..." while loading
  - On click: createWorkOrder(redirectId) → reload redirects → toast

**If HAS workOrderId:**
- Button: "İş Emrine Git" (blue, clickable)
  - Shows work order ID in toast (placeholder for navigation)
  - Future: Navigate to /workorders/{workOrderId}

## Data Flow

### Creating a Work Order
```
User clicks "İş Emri Aç" button
    ↓
handleCreateWorkOrder(redirectId)
    ↓
createWorkOrder(redirectId)
    ↓
POST /api/service-redirects/:redirectId/create-workorder
    ↓
Mock Server:
  - Validates role ≠ viewer
  - Finds redirect
  - Generates WO-ID
  - Creates WorkOrder object
  - Links redirect.workOrderId = WO-ID
  - Pushes to MOCK_WORK_ORDERS
    ↓
Returns {workOrderId, status: "Open"}
    ↓
UI:
  - Shows toast "İş Emri oluşturuldu"
  - Reloads redirects list
  - Button changes from "İş Emri Aç" → "İş Emrine Git"
```

## Testing Workflow

### Test 1: Create Work Order (Non-Viewer)
1. Open http://localhost:3003
2. Navigate to vehicle summary tab
3. In "Son Servis Yönlendirmeleri" section
4. Find redirect WITHOUT workOrderId
5. Click "İş Emri Aç" button
6. **Expected:**
   - Button shows "..." (loading)
   - Toast "İş Emri oluşturuldu" appears
   - Button changes to "İş Emrine Git" (blue)
   - Redirect now has workOrderId linked

### Test 2: Work Order Already Exists
1. On same redirect with workOrderId
2. Click "İş Emrine Git" button
3. **Expected:**
   - Toast shows work order ID (WO-XXXXX)
   - Future: Navigate to work order details

### Test 3: Viewer Role Cannot Create
1. Set role to "viewer" via role selector
2. Try to click "İş Emri Aç" button
3. **Expected:**
   - Button disabled (gray)
   - Cursor shows "not-allowed"
   - No request sent

### Test 4: Filter by Fleet
1. Open DevTools Network tab
2. Manual test: GET /api/workorders?fleetId=FLEET-001
3. **Expected:**
   - Returns work orders for only that fleet
   - All have matching fleetId

## Files Modified

| File | Changes | Status |
|------|---------|--------|
| types/fleetRental.ts | Added WorkOrder interface, workOrderId field to ServiceRedirect | ✅ |
| src/mocks/fleetRentalSeed.ts | Added MOCK_WORK_ORDERS export, WorkOrder import | ✅ |
| src/mocks/fleetRentalSeed.mjs | Same as .ts (Node.js compatibility) | ✅ |
| start-mock-server.mjs | Added MOCK_WORK_ORDERS import, 2 endpoints | ✅ |
| services/fleetRentalService.ts | Added WorkOrder import, createWorkOrder(), listWorkOrders() | ✅ |
| views/FleetRental.tsx | Added createWorkOrder import, workOrderCreating state, handleCreateWorkOrder handler, UI buttons | ✅ |

## Error Handling

**Server Errors (Mock API):**
- 403 Forbidden: Viewer role prevented from creating
- 404 Not Found: Redirect doesn't exist
- 409 Conflict: Work order already exists for redirect

**Client Errors (React):**
- Try/catch wraps all API calls
- Error messages shown via setError()
- Toast for success, error in console/UI

## Security

**Role Enforcement:**
- POST create-workorder checks `role === 'viewer'` → 403
- GET workorders allows all authenticated roles
- All endpoints require x-tenant-id header

**Data Isolation:**
- Work orders filtered by fleet when needed
- ServiceRedirect links to WorkOrder are immutable (one-way at creation)

## Next Steps (Future Enhancements)

1. **Work Order Details View:** Create `/workorders/:workOrderId` page
2. **Status Transitions:** Allow ops to change WO status (Open → InProgress → Closed)
3. **PATCH /api/workorders/:workOrderId:** Update work order status
4. **Work Order History:** Track status changes over time
5. **Report Integration:** Show work order statistics in dashboard
6. **Closure Verification:** Confirm service completion before marking as Closed

## Performance Notes

- MOCK_WORK_ORDERS starts empty (no seed data overhead)
- Work orders created on-demand via UI buttons
- No polling needed (one-time fetch per redirect)
- Array operations O(n) (acceptable for mock, would use DB in production)

## Verification Checklist

- ✅ TypeScript: Zero compilation errors
- ✅ Types: WorkOrder interface fully defined
- ✅ Types: ServiceRedirect has workOrderId field
- ✅ Seed: MOCK_WORK_ORDERS exports in both .ts and .mjs
- ✅ Imports: All dependencies imported correctly
- ✅ Endpoints: POST create-workorder role enforcement
- ✅ Endpoints: POST create-workorder validation (404, 409)
- ✅ Endpoints: GET workorders with optional filter
- ✅ Client: createWorkOrder() function ready
- ✅ Client: listWorkOrders() function ready
- ✅ UI: Buttons conditionally shown based on workOrderId
- ✅ UI: Viewer role disables "İş Emri Aç"
- ✅ UI: Loading states during creation
- ✅ UI: Toast notifications on success
- ✅ UI: Error handling with setError

## Summary

V2.3 successfully bridges Service Redirects and Work Orders for complete job tracking:
- **Types:** WorkOrder interface + ServiceRedirect.workOrderId field ✅
- **Seed:** MOCK_WORK_ORDERS array (starts empty) ✅
- **Server:** 2 endpoints (create, list) with full validation ✅
- **Client:** 2 functions (createWorkOrder, listWorkOrders) ✅
- **UI:** Conditional buttons with role enforcement + loading/error handling ✅

**Status:** Ready for testing and production deployment.
